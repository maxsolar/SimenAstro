<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿é–€å¯¦å°æ™¨å…‰å¤©æ–‡ç­è¡¨æŸ¥è©¢ç³»çµ±</title>
    <!-- Introduce Chart.js å’Œ Datalabels plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* ==================== 1. CSS style ==================== */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f9;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        /* --- Tab navigations --- */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ccc;
        }

        .tab-button {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }

        .tab-button:hover {
            background-color: #e9e9e9;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        /* --- Left-Right layout --- */
        .tab-content {
            display: none; /* Hide by default */
            padding: 20px;
        }

        .tab-content.active {
            display: block; /* é¡¯ç¤ºç›®å‰å•Ÿç”¨çš„åˆ†é å…§å®¹ */
        }

        .split-view {
            display: flex;
            min-height: 500px; /* æœ€å°é«˜åº¦ï¼Œé¿å…å…§å®¹éå°‘æ™‚é é¢å¡Œé™· */
        }

        .left-column {
            flex: 1; /* å·¦å´ä½” 1 ä»½ */
            padding-right: 20px;
            border-right: 1px solid #eee;
            max-width: 100px; /* é™åˆ¶å·¦æ¬„æœ€å¤§å¯¬åº¦ */
            min-width: 20px; /* æ–°å¢ï¼šç¢ºä¿æœ€å°å¯¬åº¦ï¼Œé˜²æ­¢è¢«å£“ç¸® */
            position: relative; /* For positioning the button */
            transition: all 0.3s ease; /* Smooth transition for collapse */
        }

        .left-column.collapsed {
            flex: 0;
            min-width: 0;
            width: 0;
            padding-right: 0;
            border-right: none;
        }

        .left-column.collapsed .left-column-content {
            display: none;
        }

        .toggle-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 24px;
            text-align: center;
            z-index: 10;
        }

        .toggle-btn:hover {
            background-color: #0056b3;
        }

        .right-column {
            flex: 3; /* å³å´ä½” 3 ä»½ */
            padding-left: 20px;
            overflow-x: auto; /* æ–°å¢ï¼šç•¶å…§å®¹éå¯¬æ™‚ï¼Œé¡¯ç¤ºæ°´å¹³æ»¾å‹•æ¢ */
        }

        /* ä½ˆå‘Šæ¬„å°ˆç”¨ï¼šç•¶æ²’æœ‰å·¦å´æ¬„æ™‚ä½¿å³å´å¯¬åº¦æ›´åˆç† */
        .right-column.full-width {
            padding-left: 20px;
            padding-right: 20px;
            overflow-x: auto;
        }

        /* --- é¸å–®æ¨£å¼ --- */
        .select-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* å¤šé¸é¸å–® */
        .multi-select {
            width: 100%;
            min-height: 200px;
            border: 1px solid #ccc;
            padding: 5px;
        }

        /* --- è¡¨æ ¼æ¨£å¼ --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .data-table th {
            background-color: #4A5568; /* æ·±ç°è‰²åº• */
            color: #FFFFFF; /* ç™½è‰²å­— */
            text-align: center;
        }

                /* é‡å°ç­ç´šæ¬„ä½ï¼ˆç¬¬ä¸€æ¬„ï¼‰é€²è¡Œæ¨£å¼è¨­å®š */
                .data-table tbody td:first-child {
                    background-color: #4A5568; /* æ·±ç°è‰²åº• */
                    color: #FFFFFF; /* ç™½è‰²å­— */
                    font-weight: bold; /* åŠ ç²—å­—é«” */
                }

                /* --- å§“åé«˜äº®æ¨£å¼ --- */
                .name-highlight {
                    cursor: pointer;
                    transition: background-color 0.2s ease-in-out;
                    border-radius: 3px;
                    padding: 0 2px;
                }
                .name-highlight.highlighted {
                    background-color: #FFD700; /* é‡‘é»ƒè‰²é«˜äº® */
                    color: #000;
                }
            </style>
        </head>
        <body>

        <div style="text-align: center; font-weight: bold; color: #008000; font-size: 16px; margin-bottom: 20px;">æ™¨å…‰å¤©æ–‡114ä¸Š<br/>Last update: 2025.12.10</div>
        <div class="container">

            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'ClassSchedule')">ç­ç´šèª²è¡¨</button>
                <button class="tab-button" onclick="openTab(event, 'PersonalSchedule')">å€‹äººèª²è¡¨</button>
                <button class="tab-button" onclick="openTab(event, 'Statistics')">çµ±è¨ˆåœ–</button>
                <button class="tab-button" onclick="openTab(event, 'Bulletin')">ä½ˆå‘Šæ¬„</button>
            </div>

            <div id="ClassSchedule" class="tab-content active">
                <div class="split-view">
                    <div class="left-column">
                        <button class="toggle-btn" onclick="toggleLeftColumn(event)">-</button>
                        <div class="left-column-content">
                            <label for="class-select" class="select-label">é¸æ“‡ç­ç´š (å¯å¤šé¸):</label>
                            <div style="margin-bottom: 5px;">
                                <button onclick="selectAllClasses(true)" style="padding: 2px 5px; font-size: 12px; margin-right: 5px; cursor: pointer;">å…¨é¸</button>
                                <button onclick="selectAllClasses(false)" style="padding: 2px 5px; font-size: 12px; margin-right: 5px; cursor: pointer;">å…¨ä¸é¸</button>
                            </div>
                            <select id="class-select" class="multi-select" multiple size="10" onchange="updateClassSchedule()">
                            </select>
                        </div>
                    </div>
                    <div class="right-column">
                        <h3>ç­ç´šèª²è¡¨</h3>
                        <table class="data-table" id="class-schedule-table">
                            <thead>
                                <tr>
                                    <th>ç­ç´š</th>
                                    <th>è€å¸«</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>ç‰ˆæœ¬</th>
                                    <th>å­¸å“¡äººæ•¸</th>
                                </tr>
                            </thead>
                            <tbody id="class-schedule-body">
                                <tr><td colspan="5">è«‹åœ¨å·¦å´é¸æ“‡ç­ç´šä»¥é¡¯ç¤ºèª²è¡¨ã€‚</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="PersonalSchedule" class="tab-content">
                <div class="split-view">
                    <div class="left-column">
                        <button class="toggle-btn" onclick="toggleLeftColumn(event)">-</button>
                        <div class="left-column-content">
                            <label for="person-select" class="select-label">é¸æ“‡åŠ©æ•™:</label>
                            <select id="person-select" class="multi-select" multiple size="10" onchange="updatePersonalSchedule()">
                            </select>
                        </div>
                    </div>
                    <div class="right-column">
                        <h3>å€‹äººèª²è¡¨</h3>
                        <table class="data-table" id="personal-schedule-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>ç­ç´š</th>
                                    <th>å–®å…ƒ</th>
                                    <th>è§’è‰²</th>
                                    <th>å¤¥ä¼´</th>
                                </tr>
                            </thead>
                            <tbody id="personal-schedule-body">
                                <tr><td colspan="5">è«‹åœ¨å·¦å´é¸æ“‡äººåä»¥é¡¯ç¤ºèª²è¡¨ã€‚</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="Statistics" class="tab-content">
                <div class="split-view">
                    <div class="left-column">
                        <button class="toggle-btn" onclick="toggleLeftColumn(event)">-</button>
                        <div class="left-column-content">
                            <label for="stats-select" class="select-label">çµ±è¨ˆç¯©é¸:</label>
                            <select id="stats-select" class="multi-select" multiple size="10" onchange="generateStatistics()">
                            </select>
                        </div>
                    </div>
                    <div class="right-column">
                        <h3>çµ±è¨ˆåœ–è¡¨</h3>
                        <div id="chart-area">
                            <div id="bar-chart-container">
                                <canvas id="barChart"></canvas>
                            </div>
                            <div id="pie-chart-container" style="margin-top: 20px; max-width: 400px;">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="Bulletin" class="tab-content">
                <div class="right-column full-width">
                    <h3>ä½ˆå‘Šæ¬„</h3>
                    <table class="data-table" id="bulletin-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ™‚é–“</th>
                                <th>åœ°é»</th>
                                <th>æ´»å‹•å…§å®¹</th>
                                <th>å‚™æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="bulletin-body">
                            <tr><td colspan="5">ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <script>
            // ==================== 2. JSON è³‡æ–™ ==================== 
            // ç­ç´šèˆ‡è€å¸«å°æ‡‰è¡¨
            const teacherDB = [
              {"101": "è¨±åª–è¯"},
              {"102": "ä½³å®œ"},
              {"201": "æ­ä¼¶ç¤½"},
              {"202": "å®‰æ·‡"},
              {"301": "æ·‘è"},
              {"302": "ä¼¶ç"},
              {"401": "éº—è"},
              {"402": "éƒé›¯"},
              {"501": "æ›¾ç‰å©·"},
              {"502": "é„§ä½³ç³"},
              {"601": "ç›§ä»•ç´”"},
              {"602": "è”¡éŠ˜ç›Š"},
              {"603": "æ¥Šæ·³æ£»"}
            ];
            // ä½ˆå‘Šæ¬„èˆ‡æ´»å‹•æ—¥æœŸ
            const bulletinDB = {
                "2026/01/09": {
                    "time": "9:00 - 11:30",
                    "location": "<a href='https://maps.app.goo.gl/LNaNLYopR1yeMz5z8'>è˜­æ½­åœ‹å°</a>",
                    "description": "æ–°å¿—å·¥åŸ¹è¨“",
                    "note": "æš«å®š/red"
                },
                "2026/01/13": {
                    "time": "9:00 - 11:30",
                    "location": "å°å—å¸‚<a href='https://maps.app.goo.gl/FLWgnQsnY8fDYfau9'>å¾©èˆˆåœ‹å°</a>",
                    "description": "æ–°å¿—å·¥åŸ¹è¨“",
                    "note": "æš«å®š/red"
                },
                "2026/01/20": {
                    "time": "9:00 - 11:30",
                    "location": "å¤§ï¼¥æ•™å®¤",
                    "description": "è©¦æ•™ï¼Œå¯éŒ„å½±ä¸Šå‚³YouTube",
                    "note": "æš«å®š/red"
                },
            }
            // èª²ç¨‹æ—¥æœŸèˆ‡åŠ©æ•™å°æ‡‰è¡¨
            // 
            // å®¢è£½åŒ–é¡è‰²èªªæ˜ï¼š
            // ä½ å¯ä»¥åœ¨ä»»ä½•ä¸»è¬›æˆ–åŠ©æ•™çš„å§“åå¾Œé¢ï¼ŒåŠ ä¸Šæ–œç·šèˆ‡é¡è‰²ä¾†æ”¹è®Šå®ƒåœ¨èª²è¡¨ä¸Šçš„é¡¯ç¤ºé¡è‰²ã€‚
            // é€™å°æ–¼æ¨™ç¤ºç‰¹å®šç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼šæ–°äººã€ä»£ç†ã€è§€å¯Ÿï¼‰éå¸¸æœ‰ç”¨ã€‚
            // 
            // æ ¼å¼: "å§“å/é¡è‰²"
            // 
            // é¡è‰²å¯ä»¥æ˜¯è‹±æ–‡å–®å­—æˆ–åå…­é€²ä½è‰²ç¢¼ã€‚ä»¥ä¸‹ç‚ºäº”ç¨®å¸¸ç”¨é¡è‰²ç¯„ä¾‹ï¼š
            //   - "å§“å/red"      (ç´…è‰²)
            //   - "å§“å/blue"     (è—è‰²)
            //   - "å§“å/green"    (ç¶ è‰²)
            //   - "å§“å/orange"   (æ©˜è‰²)
            //   - "å§“å/purple"   (ç´«è‰²)
            // 
            const classesDB = {
                "2025/09/05": {
                    "601/U4": {
                        "èŠŠèŠŠ": ["ç‘å¤«", "ç‰ä¼¶"]      
                    },
                    "602/U2": {
                        "å¤¢è": ["å°é›¨", "å°æ£»"]
                    },
                    "603/U3": {
                        "è‹±æ·³": ["ç¾éœ", "å‚‘å“¥"]
                    }
                },

                "2025/09/12": {
                    "601/U3": {
                        "è‹±æ·³": ["ç¾éœ", "èŠŠèŠŠ"]
                    },
                    "602/U1": {
                        "å°é›¨": ["çè¯", "å¤¢è", "å‚‘å“¥"]
                    },
                    "603/U2": {
                        "æ–¹ç›ˆ": ["å¥åº­", "ç‰ä¼¶"]
                    }
                },

                "2025/09/17": {
                    "601/U1": {
                        "å°é›¨": ["çè¯", "ç‰ä¼¶"]
                    },
                    "602/U3": {
                        "ç¾éœ": ["å¤¢è", "ç‘‹ç‘œ", "å°æ£»"]
                    },
                    "603/U4": {
                        "èŠŠèŠŠ": ["æ–¹ç›ˆ", "å‚‘å“¥"]
                    }
                },

                "2025/09/25": {
                    "601/U2": {
                        "å¥åº­": ["ç‘‹ç‘œ", "è‹±æ·³"]
                    },
                    "602/U4": {
                        "ç‘å¤«": ["å°é›¨", "ç¾éœ"]
                    },
                    "603/U1": {
                        "å‚‘å“¥": ["æ–¹ç›ˆ", "ç‰ä¼¶"]
                    }
                },

                "2025/09/24": {
                    "501/U1": {
                        "å°é›¨": ["ç‰ä¼¶", "çè¯"]
                    },
                    "502/U3": {
                        "ç¾éœ": ["å‚‘å“¥", "ç‘‹ç‘œ"]
                    }
                },

                "2025/10/08": {
                    "501/U2": {
                        "æ–¹ç›ˆ": ["ç‘‹ç‘œ", "ç‘å¤«", "å¥åº­"]
                    },
                    "502/U4": {
                        "èŠŠèŠŠ": ["ç‰ä¼¶", "å°æ£»"]
                    }
                },

                "2025/10/15": {
                    "501/U3": {
                        "è‹±æ·³": ["æ–¹ç›ˆ/blue", "ç¾éœ/blue", "è³¢å§/red"]
                    },
                    "502/U1": {
                        "çè¯": ["å‚‘å“¥/blue", "å°æ£»", "å°é›¨/blue"]
                    }
                },

                "2025/10/17": {
                    "501/U4": {
                        "ç‘å¤«": ["ç‘‹ç‘œ/blue", "è‹±æ·³", "å°å—/red"]
                    },
                    "502/U2": {
                       "å¤¢è/purple": ["å°é›¨", "å¥åº­/blue"]
                    }
                },

                "2025/10/02": {
                    "401/U3": {
                        "è‹±æ·³": ["å‚‘å“¥", "ç¾éœ"]
                    },
                    "402/U2": {
                        "å¤¢è": ["æ–¹ç›ˆ", "ç‘‹ç‘œ", "å¥åº­"]
                    }
                },

                "2025/10/09": {
                    "401/U2": {
                        "æ–¹ç›ˆ": ["å°é›¨", "ç‰ä¼¶"]
                    },
                    "402/U4": {
                        "èŠŠèŠŠ": ["ç‘‹ç‘œ", "å¥åº­"]
                    }
                },

                "2025/10/16": {
                    "401/U4": {
                        "èŠŠèŠŠ": ["å°æ£»", "å¥åº­/blue"]
                    },
                    "402/U1": {
                        "å°é›¨/purple": ["å¤¢è/blue", "ç‘‹ç‘œ", "æ€¡å©·/red"]
                    }
                },

                "2025/10/23": {
                    "401/U1": {
                        "å‚‘å“¥": ["æ–¹ç›ˆ", "å¥åº­"]
                    },
                    "402/U3": {
                        "ç¾éœ/purple": ["å°æ£»/blue", "ç‘‹ç‘œ", "è³¢å§/red"]
                    }
                },

                "2025/11/07": {
                    "301/U1": {
                        "å°é›¨": ["çè¯/blue", "èŠŠèŠŠ"]
                    },
                    "302/U4": {
                        "ç‘å¤«": ["å°æ£»", "å¥åº­"]
                    }
                },

                "2025/11/13": {
                    "301/U4": {
                        "èŠŠèŠŠ": ["ç‘‹ç‘œ/blue", "ç‰ä¼¶", "è‹±æ·³"]
                    },
                    "302/U3": {
                        "ç¾éœ": ["å‚‘å“¥", "å°æ£»", "æ€¡å©·/red"]
                    }
                },

                "2025/11/20": {
                    "301/U3": {
                        "è‹±æ·³": ["å°é›¨/blue", "æ–¹ç›ˆ", "æ€¡å©·/red"]
                    },
                    "302/U2": {
                     "å¥åº­/purple": ["ç¾éœ", "ç‰ä¼¶", "è³¢å§/red"]
                    }
                },

                "2025/11/21": {
                    "301/U2": {
                        "å¥åº­": ["å‚‘å“¥", "å°æ£»", "å¤¢è"]
                    },
                    "302/U1": {
                        "çè¯": ["è‹±æ·³", "è³¢å§/red", "å°å—/red"]
                    }
                },

                "2025/12/18": {
                    "201/U2": {
                        "å¥åº­": ["æ€¡å©·/red", "ç‰ä¼¶", "å¤¢è"]
                    },
                    "202/U1": {
                        "å‚‘å“¥": ["ç‘‹ç‘œ", "è‹±æ·³"]
                    }
                },

                "2025/12/19": {
                    "201/U3": {
                        "ç¾éœ": ["ç‘‹ç‘œ", "çè¯", "å°å—/red"]
                    },
                    "202/U4": {
                        "ç‘å¤«": ["è‹±æ·³", "å°é›¨"]
                    }
                },
                "2025/12/24": {
                    "201/U1": {
                        "çè¯": ["æ–¹ç›ˆ", "èŠŠèŠŠ", "ç‰ä¼¶"]
                    },
                    "202/U3": {
                        "è‹±æ·³": ["å°æ£»", "å°é›¨", "ç‘å¤«"]
                    }
                },

                "2025/12/26": {
                    "201/U4": {
                        "ç‘å¤«": ["çè¯", "å¥åº­", "å‚‘å“¥"]
                    },
                    "202/U2": {
                        "å¤¢è": ["ç‰ä¼¶", "è‹±æ·³", "æ€¡å©·/red"]
                    }
                },

                "2025/11/27": {
                    "101/U4": {
                        "èŠŠèŠŠ": ["å°æ£»", "ç‰ä¼¶", "ç‘å¤«","è³¢å§/red"]
                    },
                    "102/U2": {
                        "å¤¢è": ["å‚‘å“¥", "ç¾éœ", "æ€¡å©·/red"]
                    }
                },

                "2025/12/10": {
                    "101/U1": {
                        "å‚‘å“¥": ["çè¯", "å°é›¨", "å°æ£»"]
                    },
                    "102/U3": {
                        "è‹±æ·³": ["ç¾éœ", "ç‘‹ç‘œ", "å°å—/red"]
                    }
                },

                "2025/12/11": {
                    "101/U3": {
                        "ç¾éœ": ["å¤¢è", "å°æ£»", "å‚‘å“¥"]
                    },
                    "102/U4": {
                        "èŠŠèŠŠ": ["å°å—/red", "å°é›¨", "æ€¡å©·/red"]
                    }
                },

                "2025/12/17": {
                    "101/U2": {
                        "æ–¹ç›ˆ": ["ç¾éœ", "ç‘‹ç‘œ", "è‹±æ·³"]
                    },
                    "102/U1": {
                        "çè¯": ["èŠŠèŠŠ", "å¤¢è", "å°å—/red"]
                    }
                }
            };

            // ==================== 3. JavaScript é‚è¼¯ ====================

            // --- Tab åˆ‡æ›åŠŸèƒ½ ---
            function openTab(evt, tabName) {
                // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                });

                // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // é¡¯ç¤ºç›®å‰çš„åˆ†é ä¸¦è¨­å®š active ç‹€æ…‹
                document.getElementById(tabName).style.display = 'block';
                document.getElementById(tabName).classList.add('active');
                evt.currentTarget.classList.add('active');
            }

            // --- Left Column Toggle ---
            function toggleLeftColumn(event) {
                const button = event.target;
                const leftColumn = button.parentElement;
                leftColumn.classList.toggle('collapsed');

                if (leftColumn.classList.contains('collapsed')) {
                    button.textContent = '+';
                } else {
                    button.textContent = '-';
                }
            }

            // --- å§“åèˆ‡é¡è‰²è§£æå‡½å¼ ---
            function parseNameAndColor(inputString) {
                if (typeof inputString === 'string' && inputString.includes('/')) {
                    const parts = inputString.split('/');
                    return { name: parts[0], color: parts[1] };
                }
                return { name: inputString, color: null };
            }

            function selectAllClasses(select) {
                const classSelect = document.getElementById('class-select');
                const options = classSelect.options;
                for (let i = 0; i < options.length; i++) {
                    options[i].selected = select;
                }
                updateClassSchedule();
            }

            // --- å¡«å……é¸å–®åŠŸèƒ½ ---
            function populateDropdowns() {
                const allNames = new Set();

                // å¾ classesDB æå–ä¸»è¬›èˆ‡åŠ©æ•™å§“å
                for (const date in classesDB) {
                    const classes = classesDB[date];
                    for (const className in classes) {
                        const course = classes[className];
                        for (const speaker in course) {
                            allNames.add(parseNameAndColor(speaker).name); // æ·»åŠ ä¸»è¬› (ç´”æ·¨ç‰ˆ)
                            course[speaker].forEach(ta => allNames.add(parseNameAndColor(ta).name)); // æ·»åŠ åŠ©æ•™ (ç´”æ·¨ç‰ˆ)
                        }
                    }
                }

                // ä½¿ç”¨ localeCompare é€²è¡Œä¸­æ–‡æ’åº
                const sortedNames = Array.from(allNames).sort((a, b) => a.localeCompare(b, 'zh-Hant'));

                const personSelect = document.getElementById('person-select');
                personSelect.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

                sortedNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    personSelect.appendChild(option);
                });

                // ç‚ºäº†è®“é é¢æ›´å®Œæ•´ï¼Œä¹Ÿå¡«å……å…¶ä»–ä¸‹æ‹‰é¸å–®
                // å¡«å……ç­ç´šé¸å–®
                const classSelect = document.getElementById('class-select');
                classSelect.innerHTML = ''; // æ¸…ç©º

                // æå–æ‰€æœ‰ç­ç´š ID ä¸¦æ’åº
                const classIds = teacherDB.map(item => Object.keys(item)[0]).sort();

                // æ·»åŠ å„ç­ç´šé¸é …ä¸¦é è¨­é¸ä¸­
                classIds.forEach(classId => {
                    const option = document.createElement('option');
                    option.value = classId;
                    option.textContent = classId;
                    option.selected = true; // é è¨­é¸æ“‡æ‰€æœ‰ç­ç´š
                    classSelect.appendChild(option);
                });


                // å¡«å……çµ±è¨ˆé¸å–® (é€™è£¡æˆ‘å€‘ä¹Ÿç”¨äººåï¼Œå¯ä»¥æ ¹æ“šéœ€æ±‚æ›´æ”¹)
                const statsSelect = document.getElementById('stats-select');
                statsSelect.innerHTML = '';
                sortedNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    statsSelect.appendChild(option);
                });
            }

            // --- èª²è¡¨æ›´æ–°å‡½å¼ ---

            // æ—¥æœŸæ ¼å¼åŒ–è¼”åŠ©å‡½å¼ (ä¾‹å¦‚ "2025/09/05" -> "9/5 (äº”)")
            function formatHeaderDate(dateStr) {
                const date = new Date(dateStr);
                const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
                return `${date.getMonth() + 1}/${date.getDate()} (${dayOfWeek})`;
            }

            // å–®å…ƒé¡è‰²è¼”åŠ©å‡½å¼
            function getUnitStyle(unit) {
                const styles = {
                    'U1': { background: '#E0F7FA', color: '#00796B', name: 'æµ·æ´‹è—' },
                    'U2': { background: '#E8F5E9', color: '#2E7D32', name: 'æ£®æ—ç¶ ' },
                    'U3': { background: '#FFFDE7', color: '#F9A825', name: 'æš–é™½é»ƒ' },
                    'U4': { background: '#FCE4EC', color: '#C2185B', name: 'æ«»èŠ±ç²‰' }
                };
                return styles[unit] || { background: '#F5F5F5', color: '#333', name: 'é è¨­ç°' };
            }

                // åŒæ­¥åŒ–è¡¨æ ¼æ¬„ä½å¯¬åº¦
                function synchronizeTableWidths() {
                    const tables = document.querySelectorAll('.data-table');
                    if (tables.length === 0) return;

                    const maxWidths = [];
                    const MAX_DATE_COL_WIDTH = 180; // æ–°å¢ï¼šè¨­å®šæ—¥æœŸæ¬„ä½çš„æœ€å¤§å¯¬åº¦ä¸Šé™ (åƒç´ )

                    // æ­¥é©Ÿ 1: è¨ˆç®—æ¯ä¸€ç¸±åˆ—çš„æœ€å¤§å¯¬åº¦ï¼ŒåŒæ™‚è€ƒæ…®ä¸Šé™
                    tables.forEach(table => {
                        // æš«æ™‚é‡è¨­æ¨£å¼ä»¥å–å¾—è‡ªç„¶å¯¬åº¦
                        table.style.tableLayout = 'auto';
                        const rows = table.querySelectorAll('tr');
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('th, td');
                            cells.forEach((cell, i) => {
                                let currentMaxWidth = Math.max(maxWidths[i] || 0, cell.offsetWidth);

                                // åªå°æ—¥æœŸæ¬„ä½ (i > 0) æ‡‰ç”¨æœ€å¤§å¯¬åº¦é™åˆ¶
                                if (i > 0) {
                                    currentMaxWidth = Math.min(currentMaxWidth, MAX_DATE_COL_WIDTH);
                                }
                                maxWidths[i] = currentMaxWidth;
                            });
                        });
                    });

                    // æ­¥é©Ÿ 2: å°‡è¨ˆç®—å‡ºçš„å¯¬åº¦æ‡‰ç”¨åˆ°æ‰€æœ‰è¡¨æ ¼
                    tables.forEach(table => {
                        table.style.tableLayout = 'fixed'; // è¨­å®šç‚ºå›ºå®šä½ˆå±€
                        const headerCells = table.querySelectorAll('thead th');
                        headerCells.forEach((cell, i) => {
                            if (maxWidths[i]) {
                                cell.style.width = `${maxWidths[i]}px`;
                            }
                        });
                    });
                }

                function updateClassSchedule() {
                    const select = document.getElementById('class-select');
                    const rightColumn = document.querySelector('#ClassSchedule .right-column');

                    // ä¿ç•™ h3 æ¨™é¡Œï¼Œæ¸…ç©ºå…¶é¤˜å…§å®¹
                    const h3 = rightColumn.querySelector('h3');
                    rightColumn.innerHTML = '';
                    rightColumn.prepend(h3);

                    let selectedClasses = Array.from(select.selectedOptions).map(option => option.value);

                    // å¦‚æœé¸æ“‡äº† "å…¨é¸" æˆ–æ²’æœ‰é¸æ“‡ä»»ä½•é …ç›®ï¼ˆé è¨­ç‹€æ…‹ï¼‰ï¼Œå‰‡é¡¯ç¤ºæ‰€æœ‰ç­ç´š
                    if (selectedClasses.includes('all') || selectedClasses.length === 0) {
                        selectedClasses = teacherDB.map(item => Object.keys(item)[0]);
                    }

                    if (selectedClasses.length === 0) {
                            const p = document.createElement('p');
                            p.textContent = 'è«‹åœ¨å·¦å´é¸æ“‡ç­ç´šä»¥é¡¯ç¤ºèª²è¡¨ã€‚';
                            rightColumn.appendChild(p);
                            return;
                    }

                    // 1. é è™•ç† classesDBï¼Œå°‡å…¶çµæ§‹è½‰æ›ç‚ºä»¥ç­ç´šç‚ºä¸­å¿ƒ
                    const scheduleByClass = {};
                    for (const date in classesDB) {
                        for (const classUnitKey in classesDB[date]) {
                            const [classId, unit] = classUnitKey.split('/');
                            if (!scheduleByClass[classId]) {
                                scheduleByClass[classId] = {};
                            }
                            const courseInfo = classesDB[date][classUnitKey];
                            const speaker = Object.keys(courseInfo)[0];
                            const tas = courseInfo[speaker];

                            // è™•ç†åŒä¸€å¤©æœ‰å¤šå ‚èª²çš„æƒ…æ³
                            if (!scheduleByClass[classId][date]) {
                                scheduleByClass[classId][date] = [];
                            }
                            scheduleByClass[classId][date].push({ unit, speaker, tas });
                        }
                    }

                    // 2. æ ¹æ“šç­ç´šçš„èª²ç¨‹æ—¥æœŸé€²è¡Œåˆ†çµ„
                    const groupedByDates = {};
                    selectedClasses.forEach(classId => {
                        if (scheduleByClass[classId]) {
                            const dates = Object.keys(scheduleByClass[classId]).sort();
                            const dateKey = JSON.stringify(dates); // ä½¿ç”¨æ—¥æœŸçš„ JSON å­—ä¸²ä½œç‚º key
                            if (!groupedByDates[dateKey]) {
                                groupedByDates[dateKey] = [];
                            }
                            groupedByDates[dateKey].push(classId);
                        }
                    });

                    // æ ¹æ“šå¹´ç´šç”±å¤§åˆ°å°æ’åº table çš„ key
                    const sortedDateKeys = Object.keys(groupedByDates).sort((a, b) => {
                        const classA = groupedByDates[a][0]; 
                        const classB = groupedByDates[b][0];
                        return parseInt(classB.charAt(0)) - parseInt(classA.charAt(0));
                    });

                    // 3. ç‚ºæ¯å€‹åˆ†çµ„ç”Ÿæˆä¸€å€‹ table (ä½¿ç”¨æ’åºå¾Œçš„ keys)
                    sortedDateKeys.forEach((dateKey, index) => {
                        const classIds = groupedByDates[dateKey].sort(); // ç­ç´šç”±å°åˆ°å¤§æ’åº
                        const dates = JSON.parse(dateKey);

                        const table = document.createElement('table');
                        table.className = 'data-table';

                        // å»ºç«‹è¡¨é ­
                        const thead = table.createTHead();
                        const headerRow = thead.insertRow();

                        // å»ºç«‹ç­ç´šè¡¨é ­ (ä½¿ç”¨ <th>)
                        const classHeader = document.createElement('th');
                        classHeader.textContent = 'ç­ç´š';
                        headerRow.appendChild(classHeader);

                        // å»ºç«‹æ—¥æœŸè¡¨é ­ (ä½¿ç”¨ <th>)
                        dates.forEach(date => {
                            const dateHeader = document.createElement('th');
                            dateHeader.textContent = formatHeaderDate(date);
                            headerRow.appendChild(dateHeader);
                        });

                        // å»ºç«‹è¡¨èº«
                        const tbody = table.createTBody();
                        classIds.forEach(classId => {
                            const teacherName = teacherDB.find(item => item[classId])[classId];
                            const row = tbody.insertRow();

                            const classCell = row.insertCell();
                            classCell.innerHTML = `${classId}<br>${teacherName}`;

                            dates.forEach(date => {
                                const cell = row.insertCell();
                                const daySchedule = scheduleByClass[classId][date];
                                if (daySchedule) {
                                    cell.style.textAlign = 'center';
                                    cell.innerHTML = daySchedule.map(course => {
                                        const style = getUnitStyle(course.unit);
                                        const unitHtml = `<strong style="display: inline-block; padding: 2px 5px; border-radius: 4px; background-color: ${style.background}; color: ${style.color};">${course.unit}</strong>`;

                                        const speakerInfo = parseNameAndColor(course.speaker);
                                        const speakerStyle = speakerInfo.color ? ` style="color: ${speakerInfo.color};"` : '';
                                        const speakerHtml = `<span class="name-highlight"${speakerStyle}>${speakerInfo.name}</span>`;

                                        const tasHtml = course.tas.map(ta => {
                                            const taInfo = parseNameAndColor(ta);
                                            const taStyle = taInfo.color ? ` style="color: ${taInfo.color};"` : '';
                                            return `<span class="name-highlight"${taStyle}>${taInfo.name}</span>`;
                                        }).join(' ');

                                        return `${unitHtml}<br>${speakerHtml}<br>${tasHtml}`;
                                    }).join('<br><br>');
                                }
                            });
                        });

                        rightColumn.appendChild(table);

                        // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹ tableï¼Œå‰‡æ·»åŠ é–“éš”
                        if (index < sortedDateKeys.length - 1) {
                            const spacer = document.createElement('div');
                            spacer.style.height = '20px';
                            rightColumn.appendChild(spacer);
                        }
                    });

                    // æœ€å¾Œï¼ŒåŒæ­¥åŒ–æ‰€æœ‰è¡¨æ ¼çš„å¯¬åº¦
                    synchronizeTableWidths();
                }

                // --- å€‹äººèª²è¡¨æ›´æ–°å‡½å¼ ---

                // åˆ¤æ–·æ—¥æœŸç‹€æ…‹ (éå»/æœ¬é€±/æœªä¾†)
                function getDateStatus(dateStr) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // è¨­å®šç‚ºä»Šå¤©å‡Œæ™¨

                    const eventDate = new Date(dateStr);
                    eventDate.setHours(0, 0, 0, 0);

                    // åˆ¤æ–·æ˜¯å¦ç‚ºéå»
                    if (eventDate < today) {
                        return 'past';
                    }

                    // åˆ¤æ–·æ˜¯å¦ç‚ºæœ¬é€±
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay()); // å‡è¨­é€±æ—¥ç‚ºä¸€é€±çš„é–‹å§‹
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);

                    if (eventDate >= startOfWeek && eventDate <= endOfWeek) {
                        return 'present';
                    }

                    // å‰©ä¸‹çš„å°±æ˜¯æœªä¾†
                    return 'future';
                }

                function updatePersonalSchedule() {
                    const select = document.getElementById('person-select');
                    const selectedNames = Array.from(select.selectedOptions).map(option => option.value);
                    const tbody = document.getElementById('personal-schedule-body');
                    const h3 = document.querySelector('#PersonalSchedule .right-column h3');
                    tbody.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

                    if (selectedNames.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5">è«‹åœ¨å·¦å´é¸æ“‡äººåä»¥é¡¯ç¤ºèª²è¡¨ã€‚</td></tr>';
                            h3.textContent = 'å€‹äººèª²è¡¨';
                            return;
                    }

                    h3.textContent = selectedNames.join(', ') + 'èª²è¡¨';

                    let personSchedule = [];

                    // 1. éæ­· DB æ”¶é›†æ‰€æœ‰ç›¸é—œèª²ç¨‹
                    for (const date in classesDB) {
                        for (const classUnitKey in classesDB[date]) {
                            const [classId, unit] = classUnitKey.split('/');
                            const courseInfo = classesDB[date][classUnitKey];

                            for (const speakerWithColor in courseInfo) {
                                const speakerInfo = parseNameAndColor(speakerWithColor);
                                const tasWithColor = courseInfo[speakerWithColor];
                                const taNames = tasWithColor.map(ta => parseNameAndColor(ta).name);
                                const allParticipants = [speakerInfo.name, ...taNames];

                                // æª¢æŸ¥ä¸»è¬›
                                if (selectedNames.includes(speakerInfo.name)) {
                                    const partners = allParticipants.filter(p => p !== speakerInfo.name);
                                    personSchedule.push({ date, classId, unit, role: 'ä¸»è¬›', partners });
                                }

                                // æª¢æŸ¥åŠ©æ•™
                                tasWithColor.forEach(taWithColor => {
                                    const taInfo = parseNameAndColor(taWithColor);
                                    if (selectedNames.includes(taInfo.name)) {
                                        const partners = allParticipants.filter(p => p !== taInfo.name);
                                        personSchedule.push({ date, classId, unit, role: 'åŠ©æ•™', partners });
                                    }
                                });
                            }
                        }
                    }

                    // 2. æŒ‰æ—¥æœŸæ’åº
                    personSchedule.sort((a, b) => new Date(a.date) - new Date(b.date));

                    // 3. æ¸²æŸ“è¡¨æ ¼
                            if (personSchedule.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="5">æ‰€é¸äººåæš«ç„¡èª²ç¨‹è³‡æ–™ã€‚</td></tr>';
                            } else {
                                personSchedule.forEach(item => {
                                    const row = tbody.insertRow();
                                    const dateStatus = getDateStatus(item.date);

                                    // æ ¹æ“šæ—¥æœŸç‹€æ…‹æ‡‰ç”¨æ¨£å¼
                                    if (dateStatus === 'past') {
                                        row.style.color = '#999'; // ç°è‰²
                                    } else if (dateStatus === 'present') {
                                        row.style.fontWeight = 'bold';
                                        row.style.backgroundColor = '#FFFDE7'; // æš–é»ƒè‰²
                                    }

                                    row.insertCell(0).textContent = formatHeaderDate(item.date);
                                    row.insertCell(1).textContent = item.classId;
                                    row.insertCell(2).textContent = item.unit;
                                    const roleCell = row.insertCell(3);
                                    row.insertCell(4).textContent = item.partners.join(', ');

                                    // è¨­å®šè§’è‰²æ¬„ä½çš„å…§å®¹èˆ‡æ¨£å¼
                                    if (item.role === 'ä¸»è¬›') {
                                        const roleContent = 'ğŸ¤ ' + item.role;
                                        if (dateStatus !== 'past') {
                                            roleCell.innerHTML = `<strong style="color: blue;">${roleContent}</strong>`;
                                        } else {
                                            roleCell.textContent = roleContent;
                                        }
                                    } else if (item.role === 'åŠ©æ•™') {
                                        roleCell.textContent = item.role + ' ğŸ’ª';
                                    } else {
                                        roleCell.textContent = item.role;
                                    }
                                });
                            }
                }

                // --- Global Chart Instances ---
                let barChartInstance = null;
                let pieChartInstance = null;

                // --- Data Calculation ---
                function calculateAllStats() {
                    const stats = {};

                    // Initialize stats for all known names to ensure everyone appears, even with 0 contributions
                    const allNames = new Set();
                    for (const date in classesDB) {
                        const classes = classesDB[date];
                        for (const className in classes) {
                            const course = classes[className];
                            for (const speaker in course) {
                                allNames.add(parseNameAndColor(speaker).name);
                                course[speaker].forEach(ta => allNames.add(parseNameAndColor(ta).name));
                            }
                        }
                    }

                    allNames.forEach(name => {
                        stats[name] = {
                            speakerCount: 0,
                            taCount: 0,
                            unitCounts: { 'U1': 0, 'U2': 0, 'U3': 0, 'U4': 0 }
                        };
                    });

                    // Iterate through the DB to populate the stats
                    for (const date in classesDB) {
                        for (const classUnitKey in classesDB[date]) {
                            const [classId, unit] = classUnitKey.split('/');
                            const courseInfo = classesDB[date][classUnitKey];

                            for (const speakerWithColor in courseInfo) {
                                const speakerInfo = parseNameAndColor(speakerWithColor);
                                const tasWithColor = courseInfo[speakerWithColor];

                                // Process speaker
                                if (stats[speakerInfo.name]) {
                                    stats[speakerInfo.name].speakerCount++;
                                    if (stats[speakerInfo.name].unitCounts[unit] !== undefined) {
                                        stats[speakerInfo.name].unitCounts[unit]++;
                                    }
                                }

                                // Process TAs
                                tasWithColor.forEach(taWithColor => {
                                    const taInfo = parseNameAndColor(taWithColor);
                                    if (stats[taInfo.name]) {
                                        stats[taInfo.name].taCount++;
                                        if (stats[taInfo.name].unitCounts[unit] !== undefined) {
                                            stats[taInfo.name].unitCounts[unit]++;
                                        }
                                    }
                                });
                            }
                        }
                    }
                    // Convert the stats object to an array and sort by total contributions
                    return Object.entries(stats)
                                    .map(([name, data]) => ({ name, ...data }));
                }


                // --- Chart Generation ---
                function generateStatistics() {
                    const select = document.getElementById('stats-select');
                    const pieChartContainer = document.getElementById('pie-chart-container');
                    const selectedNames = Array.from(select.selectedOptions).map(option => option.value);
                    const allStatsUnsorted = calculateAllStats();

                    const nameToStatsMap = new Map(allStatsUnsorted.map(s => [s.name, s]));
                    const dropdownOrderNames = Array.from(select.options).map(option => option.value);

                    let statsToDisplay = [];

                    if (selectedNames.length > 0) {
                        // Filter and order by selected names from dropdown
                        dropdownOrderNames.forEach(name => {
                            if (selectedNames.includes(name) && nameToStatsMap.has(name)) {
                                statsToDisplay.push(nameToStatsMap.get(name));
                            }
                        });
                        pieChartContainer.style.display = 'block';
                    } else {
                        // Default: show all stats in dropdown order
                        dropdownOrderNames.forEach(name => {
                            if (nameToStatsMap.has(name)) {
                                statsToDisplay.push(nameToStatsMap.get(name));
                            }
                        });
                        pieChartContainer.style.display = 'none';
                    }

                    // --- Bar Chart ---
                    if (barChartInstance) {
                        barChartInstance.destroy();
                    }

                    // Find the maximum value for the x-axis to set the scale range
                    let maxValue = 0;
                    if (statsToDisplay.length > 0) {
                        const allCounts = statsToDisplay.flatMap(s => [s.speakerCount, s.taCount]);
                        maxValue = Math.max(...allCounts);
                    }

                    const barCtx = document.getElementById('barChart').getContext('2d');
                    barChartInstance = new Chart(barCtx, {
                        type: 'bar',
                        data: {
                            labels: statsToDisplay.map(s => `${s.name} (${s.speakerCount + s.taCount})`),
                            datasets: [
                                {
                                    label: 'ä¸»è¬›æ¬¡æ•¸',
                                    data: statsToDisplay.map(s => s.speakerCount),
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'åŠ©æ•™æ¬¡æ•¸',
                                    data: statsToDisplay.map(s => s.taCount),
                                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            indexAxis: 'y', // This makes it horizontal
                            responsive: true,
                            scales: {
                                x: { // Swapped from y to x
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1 // Ensure x-axis has integer steps
                                    },
                                    max: maxValue + 1 // Add 1 for padding
                                }
                            },
                            plugins: {
                                datalabels: {
                                    anchor: 'end',
                                    align: 'right', // Adjusted for horizontal bars
                                    formatter: (value) => value > 0 ? value : '', // Don't show '0' labels
                                    color: '#333',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'æœ¬å­¸æœŸä¸»è¬›èˆ‡åŠ©æ•™æ¬¡æ•¸çµ±è¨ˆ(åŒ…å«æœªå®Œæˆ)'
                                }
                            }
                        },
                        plugins: [ChartDataLabels] // Register the plugin globally
                    });

                    // --- Pie Chart (only if names are selected) ---
                    if (pieChartInstance) {
                        pieChartInstance.destroy();
                    }
                    if (selectedNames.length > 0) {
                        const pieCtx = document.getElementById('pieChart').getContext('2d');

                        const totalUnitCounts = { 'U1': 0, 'U2': 0, 'U3': 0, 'U4': 0 };
                        statsToDisplay.forEach(person => {
                            for (const unit in person.unitCounts) {
                                totalUnitCounts[unit] += person.unitCounts[unit];
                            }
                        });

                        const unitData = Object.values(totalUnitCounts);
                        const unitLabels = Object.keys(totalUnitCounts);

                        // Filter out units with 0 count to avoid cluttering the pie chart
                        const filteredUnitData = [];
                        const filteredUnitLabels = [];
                        const filteredUnitColors = [];

                        unitData.forEach((count, index) => {
                            if (count > 0) {
                                filteredUnitData.push(count);
                                const unit = unitLabels[index];
                                filteredUnitLabels.push(unit);
                                filteredUnitColors.push(getUnitStyle(unit).background);
                            }
                        });

                        pieChartInstance = new Chart(pieCtx, {
                            type: 'pie',
                            data: {
                                labels: filteredUnitLabels,
                                datasets: [{
                                    data: filteredUnitData,
                                    backgroundColor: filteredUnitColors,
                                    borderColor: '#fff',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                    },
                                    title: {
                                        display: true,
                                        text: `${selectedNames.join(', ')} å–®å…ƒåˆ†ä½ˆ`
                                    },
                                    datalabels: {
                                        formatter: (value, ctx) => {
                                            const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            if (sum === 0) return '0%';
                                            const percentage = (value / sum * 100).toFixed(1) + '%';
                                            return percentage;
                                        },
                                        color: '#000',
                                    }
                                }
                            },
                            plugins: [ChartDataLabels]
                        });
                    }
                }

                // --- Bulletin helpers & rendering ---
                function computeDurationText(timeStr) {
                    try {
                        if (typeof timeStr !== 'string') return null;
                        const match = timeStr.match(/(\d{1,2}:\d{2})\s*[-â€“â€”]\s*(\d{1,2}:\d{2})/);
                        if (!match) return null;
                        const toMinutes = t => {
                            const [hh, mm] = t.split(':').map(Number);
                            return hh * 60 + mm;
                        };
                        const start = toMinutes(match[1]);
                        const end = toMinutes(match[2]);
                        const diff = end - start;
                        if (isNaN(diff) || diff <= 0) return null;
                        let hours = diff / 60;
                        // If integer, show integer; otherwise round to 1 decimal
                        hours = Math.abs(hours - Math.round(hours)) < 0.01 ? Math.round(hours) : Math.round(hours * 10) / 10;
                        return `(${hours}hrs)`;
                    } catch (e) {
                        return null; // On any exception, don't show duration
                    }
                }

                function updateBulletin() {
                    const tbody = document.getElementById('bulletin-body');
                    tbody.innerHTML = '';

                    const dates = Object.keys(bulletinDB).sort((a, b) => new Date(a) - new Date(b));
                    if (dates.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5">ç›®å‰æ²’æœ‰å…¬å‘Šã€‚</td></tr>';
                        return;
                    }

                    dates.forEach(date => {
                        const entry = bulletinDB[date] || {};
                        const timeStr = entry.time || '';
                        const durationText = computeDurationText(timeStr);
                        const timeDisplay = durationText ? `${timeStr} ${durationText}` : timeStr;

                        const locationHtml = entry.location || '';

                        const desc = parseNameAndColor(entry.description || '');
                        const note = parseNameAndColor(entry.note || '');

                        const tr = document.createElement('tr');
                        if (getDateStatus(date) === 'past') {
                            tr.style.color = '#999';
                        }

                        const tdDate = document.createElement('td'); tdDate.textContent = formatHeaderDate(date);
                        const tdTime = document.createElement('td'); tdTime.textContent = timeDisplay;
                        const tdLoc = document.createElement('td'); tdLoc.innerHTML = locationHtml; // allow href in location
                        const tdDesc = document.createElement('td');
                        if (desc.color) {
                            tdDesc.innerHTML = `<span style="color:${desc.color};">${desc.name}</span>`;
                        } else {
                            tdDesc.textContent = desc.name;
                        }
                        const tdNote = document.createElement('td');
                        if (note.color) {
                            tdNote.innerHTML = `<span style="color:${note.color};">${note.name}</span>`;
                        } else {
                            tdNote.textContent = note.name;
                        }

                        tr.appendChild(tdDate);
                        tr.appendChild(tdTime);
                        tr.appendChild(tdLoc);
                        tr.appendChild(tdDesc);
                        tr.appendChild(tdNote);

                        tbody.appendChild(tr);
                    });

                    // Keep table width consistent with others
                    synchronizeTableWidths();
                }

                // --- é é¢å•Ÿå‹• ---
                window.onload = function() {
                    populateDropdowns(); // åˆå§‹åŒ–æ‰€æœ‰é¸å–®
                    updateClassSchedule(); // é è¨­è¼‰å…¥ 'ç­ç´šèª²è¡¨' åˆ†é çš„å…§å®¹
                    generateStatistics(); // é è¨­è¼‰å…¥çµ±è¨ˆåœ–è¡¨
                    updateBulletin(); // è¼‰å…¥ä½ˆå‘Šæ¬„å…§å®¹

                    // --- å§“åé«˜äº®äº‹ä»¶ç›£è½ ---
                    const classScheduleTab = document.getElementById('ClassSchedule');
                    const rightColumn = classScheduleTab.querySelector('.right-column');

                    rightColumn.addEventListener('click', function(event) {
                        const target = event.target;

                        // æª¢æŸ¥é»æ“Šçš„æ˜¯å¦æ˜¯å¸¶æœ‰ 'name-highlight' class çš„ span
                        if (target.classList.contains('name-highlight')) {
                            const clickedName = target.textContent;
                            const isAlreadyHighlighted = target.classList.contains('highlighted');

                            // 1. æ¸…é™¤æ‰€æœ‰ç¾æœ‰çš„é«˜äº®
                            const allNames = rightColumn.querySelectorAll('.name-highlight');
                            allNames.forEach(nameSpan => {
                                nameSpan.classList.remove('highlighted');
                            });

                            // 2. å¦‚æœé»æ“Šçš„ä¸æ˜¯å·²é«˜äº®çš„ï¼Œå‰‡æ‡‰ç”¨æ–°çš„é«˜äº®
                            if (!isAlreadyHighlighted) {
                                allNames.forEach(nameSpan => {
                                    if (nameSpan.textContent === clickedName) {
                                        nameSpan.classList.add('highlighted');
                                    }
                                });
                            }
                        }
                    });
                };
    </script>
</body>
</html>
